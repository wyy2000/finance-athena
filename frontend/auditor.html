<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ ¸å‘˜å·¥ä½œå°</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            border: 2px solid #eee;
            border-radius: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .dashboard {
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .review-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .review-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .customer-name {
            font-weight: bold;
            font-size: 18px;
        }
        .risk-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .risk-conservative {
            background: #e8f5e8;
            color: #4CAF50;
        }
        .risk-moderate {
            background: #fff3e0;
            color: #FF9800;
        }
        .risk-aggressive {
            background: #ffebee;
            color: #F44336;
        }
        .review-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .review-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }
        .btn-approve {
            background: #4CAF50;
        }
        .btn-reject {
            background: #F44336;
        }
        .btn-view {
            background: #2196F3;
        }
        .logout-btn {
            background: #666;
            margin-bottom: 20px;
            width: auto;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å®¡æ ¸å‘˜å·¥ä½œå°</h1>
            <p>ç®¡ç†å®¢æˆ·æŠ•èµ„é£é™©è¯„ä¼°ç”³è¯·</p>
        </div>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div class="login-section" id="login-section">
            <h3>å®¡æ ¸å‘˜ç™»å½•</h3>
            <form id="login-form">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" class="form-input" name="username" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" class="form-input" name="password" required>
                </div>
                <button type="submit" class="btn">ç™»å½•</button>
            </form>
            <div class="error-message" id="login-error"></div>
        </div>

        <!-- å·¥ä½œå°åŒºåŸŸ -->
        <div class="dashboard" id="dashboard">
            <button class="btn logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="pending-count">0</div>
                    <div class="stat-label">å¾…å®¡æ ¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approved-count">0</div>
                    <div class="stat-label">å·²é€šè¿‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-investment">0</div>
                    <div class="stat-label">æŠ•èµ„æ€»é¢(ä¸‡)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="success-rate">98%</div>
                    <div class="stat-label">å®¡æ ¸é€šè¿‡ç‡</div>
                </div>
            </div>

            <div class="review-list">
                <h3>å¾…å®¡æ ¸ç”³è¯·</h3>
                <div id="review-items"></div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;

        // ç™»å½•è¡¨å•æäº¤
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch('/api/v1/auditors/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.access_token;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                document.getElementById('login-error').style.display = 'block';
            }
        });

        // åŠ è½½å·¥ä½œå°æ•°æ®
        async function loadDashboard() {
            try {
                const response = await fetch('/api/v1/workflow/workflow', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateStats(result.data);
                    updateReviewList(result.data.pending_list);
                }
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œå°æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(data) {
            document.getElementById('pending-count').textContent = data.pending_count;
            document.getElementById('approved-count').textContent = data.approved_count;
            document.getElementById('total-investment').textContent = (data.total_investment / 10000).toFixed(1);
        }

        // æ›´æ–°å®¡æ ¸åˆ—è¡¨
        function updateReviewList(pendingList) {
            const container = document.getElementById('review-items');
            
            if (pendingList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å¾…å®¡æ ¸ç”³è¯·</p>';
                return;
            }

            container.innerHTML = pendingList.map(item => `
                <div class="review-item">
                    <div class="review-header">
                        <div class="customer-name">${item.customer_name}</div>
                        <div class="risk-badge risk-${item.risk_level}">${item.risk_level}</div>
                    </div>
                    <div class="review-details">
                        <p><strong>ç”³è¯·ç¼–å·:</strong> ${item.application_id}</p>
                        <p><strong>æŠ•èµ„é‡‘é¢:</strong> ${(item.investment_amount / 10000).toFixed(1)}ä¸‡å…ƒ</p>
                        <p><strong>æäº¤æ—¶é—´:</strong> ${new Date(item.submitted_at).toLocaleString()}</p>
                        <p><strong>ä¼˜å…ˆçº§:</strong> ${item.priority === 'high' ? 'é«˜' : 'æ™®é€š'}</p>
                    </div>
                    <div class="review-actions">
                        <button class="btn btn-small btn-view" onclick="viewDetails(${item.customer_id})">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-small btn-approve" onclick="approveApplication(${item.customer_id})">é€šè¿‡</button>
                        <button class="btn btn-small btn-reject" onclick="rejectApplication(${item.customer_id})">æ‹’ç»</button>
                    </div>
                </div>
            `).join('');
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(customerId) {
            alert(`æŸ¥çœ‹å®¢æˆ· ${customerId} çš„è¯¦ç»†ä¿¡æ¯`);
        }

        // é€šè¿‡ç”³è¯·
        async function approveApplication(customerId) {
            if (confirm('ç¡®è®¤é€šè¿‡æ­¤ç”³è¯·ï¼Ÿ')) {
                await submitAudit(customerId, 'approved');
            }
        }

        // æ‹’ç»ç”³è¯·
        async function rejectApplication(customerId) {
            if (confirm('ç¡®è®¤æ‹’ç»æ­¤ç”³è¯·ï¼Ÿ')) {
                await submitAudit(customerId, 'rejected');
            }
        }

        // æäº¤å®¡æ ¸ç»“æœ
        async function submitAudit(customerId, status) {
            try {
                const response = await fetch('/api/v1/workflow/audit', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        audit_status: status,
                        audit_opinion: status === 'approved' ? 'å®¡æ ¸é€šè¿‡' : 'å®¡æ ¸ä¸é€šè¿‡'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('å®¡æ ¸æäº¤æˆåŠŸ');
                    loadDashboard(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    alert('å®¡æ ¸æäº¤å¤±è´¥: ' + result.detail);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            authToken = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-form').reset();
            document.getElementById('login-error').style.display = 'none';
        }
    </script>
</body>
</html>
